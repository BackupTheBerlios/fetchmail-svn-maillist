<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [fetchmail-svn] r5218 - branches/BRANCH_MAPI
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/fetchmail-svn/2008-July/index.html" >
   <LINK REL="made" HREF="mailto:fetchmail-svn%40lists.berlios.de?Subject=Re%3A%20%5Bfetchmail-svn%5D%20r5218%20-%20branches/BRANCH_MAPI&In-Reply-To=%3C20080717134147.D96BE6B00FE%40mknod.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000205.html">
   <LINK REL="Next"  HREF="000207.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[fetchmail-svn] r5218 - branches/BRANCH_MAPI</H1>
    <B>svn at mknod.org</B> 
    <A HREF="mailto:fetchmail-svn%40lists.berlios.de?Subject=Re%3A%20%5Bfetchmail-svn%5D%20r5218%20-%20branches/BRANCH_MAPI&In-Reply-To=%3C20080717134147.D96BE6B00FE%40mknod.org%3E"
       TITLE="[fetchmail-svn] r5218 - branches/BRANCH_MAPI">svn at mknod.org
       </A><BR>
    <I>Thu Jul 17 15:41:47 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000205.html">[fetchmail-svn] r5217 - branches/BRANCH_MAPI
</A></li>
        <LI>Next message: <A HREF="000207.html">[fetchmail-svn] r5219 - branches/BRANCH_MAPI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#206">[ date ]</a>
              <a href="thread.html#206">[ thread ]</a>
              <a href="subject.html#206">[ subject ]</a>
              <a href="author.html#206">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: yangyanl
Date: 2008-07-17 08:41:47 -0500 (Thu, 17 Jul 2008)
New Revision: 5218

Modified:
   branches/BRANCH_MAPI/mapi.c
   branches/BRANCH_MAPI/transact.c
Log:
fixed some bugs in fetch_header and fetch_body.

Modified: branches/BRANCH_MAPI/mapi.c
===================================================================
--- branches/BRANCH_MAPI/mapi.c	2008-07-14 14:52:55 UTC (rev 5217)
+++ branches/BRANCH_MAPI/mapi.c	2008-07-17 13:41:47 UTC (rev 5218)
@@ -38,7 +38,6 @@
 #include  &quot;socket.h&quot;
 #include  &quot;i18n.h&quot;
 
-#define MAX_EMAIL	1024
 #define DEFAULT_MAPI_PROFILES &quot;%s/.fetchmail_mapi_profiles.ldb&quot;
 
 static TALLOC_CTX *mapi_mem_ctx;
@@ -46,6 +45,7 @@
 static mapi_object_t mapi_obj_store;
 static mapi_object_t mapi_obj_inbox;
 static mapi_object_t mapi_obj_table;
+static mapi_id_array_t mapi_deleted_ids;
 static struct SRowSet mapi_rowset;
 static int      mapi_initialized = FALSE;
 /*
@@ -54,26 +54,18 @@
 static char     mapi_profdb[1024];	/* mapi profiles databse */
 static char     password[128];
 
+
 static DATA_BLOB mapi_buffer;
 static int      mapi_buffer_count;
 
- /*
-  * :WORKAROUND:07/03/08 21:26:21:: Message numbers of deleted emails
-  * Message numbers are used to keep track of emails in one session in
-  * POP3 and IMAP, and this is handled in the server side. But there is no 
-  * message number in MAPI, so the orders of emails appearing in the
-  * mapi_obj_table are considered as their message number as a workaround. 
-  */
 
-/*-----------------------------------------------------------------------------
- *  entry[0] indicates how many entries are in the list
- *-----------------------------------------------------------------------------*/
-#define MAPI_DELETED_LIST 1
-#define MAPI_SEEN_LIST   2
-static int      mapi_deleted_list[MAX_EMAIL + 1];
-static int      mapi_seen_list[MAX_EMAIL + 1];
-
-
+/*
+ * ===  FUNCTION  ======================================================================
+ *         Name:  MapiRead
+ *  Description:  match the interface of SockRead in socket.h to feed the driver with
+ *                MAPI data.
+ * =====================================================================================
+ */
 int
 MapiRead(int sock, char *buf, int len)
 {
@@ -92,9 +84,17 @@
 	    return count;
 	}
     }
+
     return -1;
 }
 
+
+/*
+ * ===  FUNCTION  ======================================================================
+ *         Name:  MapiPeek
+ *  Description:  match the interface to SockPeek.
+ * =====================================================================================
+ */
 int
 MapiPeek(int sock)
 {
@@ -105,6 +105,7 @@
 }
 
 
+
 static const char *
 get_filename(const char *filename)
 {
@@ -127,13 +128,13 @@
 ldb_base64_encode(void *mem_ctx, const char *buf, int len)
 {
     const char     *b64 = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;
-    int             bit_offset,
-                    byte_offset,
-                    idx,
-                    i;
+    int             bit_offset;
+    int             byte_offset;
+    int             idx;
+    int             i;
     const uint8_t  *d = (const uint8_t *) buf;
-    int             bytes = (len * 8 + 5) / 6,
-	pad_bytes = (bytes % 4) ? 4 - (bytes % 4) : 0;
+    int             bytes = (len * 8 + 5) / 6;
+    int             pad_bytes = (bytes % 4) ? 4 - (bytes % 4) : 0;
     char           *out;
 
     out = talloc_array(mem_ctx, char, bytes + pad_bytes + 1);
@@ -175,29 +176,23 @@
     DATA_BLOB       data;
     magic_t         cookie = NULL;
 
-    data.length = 0;
-    data.data = talloc_size(mem_ctx, size);
-
     retval = OpenStream(&amp;obj_attach, PR_ATTACH_DATA_BIN, 0, &amp;obj_stream);
     if (retval != MAPI_E_SUCCESS)
 	return false;
 
-    if (size &lt; MSGBUFSIZE) {
-	retval = ReadStream(&amp;obj_stream, buf, size, &amp;read_size);
-	if (retval != MAPI_E_SUCCESS)
-	    return NULL;
-	memcpy(data.data, buf, read_size);
-    }
+    retval = GetStreamSize(&amp;obj_stream, &amp;data.length);
+    if (retval != MAPI_E_SUCCESS)
+	return false;
+    data.data = talloc_size(mem_ctx, data.length);
 
-    for (stream_size = 0; stream_size &lt; size; stream_size += MSGBUFSIZE) {
+    read_size = size;
+    for (stream_size = 0; stream_size &lt; data.length &amp;&amp; read_size != 0; stream_size += MSGBUFSIZE) {
 	retval = ReadStream(&amp;obj_stream, buf, max_read_size, &amp;read_size);
 	if (retval != MAPI_E_SUCCESS)
 	    return NULL;
-	memcpy(data.data + stream_size, buf, read_size);
+	memcpy(data.data, buf, read_size);
     }
 
-    data.length = size;
-
     cookie = magic_open(MAGIC_MIME);
     if (cookie == NULL) {
 	printf(&quot;%s\n&quot;, magic_error(cookie));
@@ -217,6 +212,13 @@
     return (ldb_base64_encode(mem_ctx, (const char *) data.data, data.length));
 }
 
+
+/*
+ * ===  FUNCTION  ======================================================================
+ *         Name:  is_safe_char
+ *  Description:  check if a character is safe to be represented as the ASCII character.
+ * =====================================================================================
+ */
 static int
 is_safe_char(char ch)
 {
@@ -230,14 +232,22 @@
 	|| ch == '-' || ch == '.' || ch == '/' || ch == ':' || ch == '=' || ch == '?';
 }
 
+
+/*
+ * ===  FUNCTION  ======================================================================
+ *         Name:  quoted_printable_encode
+ *  Description:  encode the body and append it to mapi_buffer 
+ * =====================================================================================
+ */
 static void
-quoted_printable_encode(const DATA_BLOB * body)
+quoted_printable_encode(const DATA_BLOB * body, int *lenp)
 {
     int             line_count = 0;
     int             body_count = 0;
     char            hex[16] = &quot;0123456789ABCDEF&quot;;
     char            ch;
     char            line[78];
+
     while (body_count &lt; body-&gt;length) {
 	ch = *(body-&gt;data + body_count);
 	body_count++;
@@ -257,6 +267,7 @@
 	    line[line_count] = '\n';
 
 	    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, line, line_count);
+	    *lenp += line_count;
 
 	    line_count = 0;
 	}
@@ -265,51 +276,10 @@
 	line[line_count++] = '\r';
 	line[line_count] = '\n';
 	data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, line, line_count);
+	*lenp += line_count;
     }
 }
 
-/*
- * ===  FUNCTION  ======================================================================
- *         Name:  insert
- *  Description:  insert the number of an email to the given list
- * =====================================================================================
- */
-static int
-insert(int msg_num, int list)
-{
-    int            *p = NULL;
-    int             idx;
-
-    if (list == MAPI_DELETED_LIST)
-	p = mapi_deleted_list;
-    else
-	p = mapi_seen_list;
-
-    if (p[0] == MAX_EMAIL) {
-	if (outlevel == O_DEBUG)
-	    report(stderr, GT_(&quot;MAPI: can not handle more items in mapi_seen_list or mapi_deleted_list\n&quot;));
-	return FALSE;
-    }
-
-    for (idx = p[0]; idx &gt;= 1; idx--) {
-	if (p[idx] == msg_num)
-	    return TRUE;
-	if (p[idx] &lt; msg_num)
-	    break;
-    }
-
-    p[0]++;
-    for (idx = p[0]; idx &gt; 1; idx--) {
-	if (p[idx - 1] &gt; msg_num) {
-	    p[idx] = p[idx - 1];
-	} else
-	    break;
-    }
-    p[idx] = msg_num;
-
-    return TRUE;
-}
-
 static void
 mapi_clean()
 {
@@ -332,8 +302,6 @@
     struct SPropTagArray *SPropTagArray = NULL;
     const char     *profname;
     uint32_t        count;
-    if (mapi_initialized)
-	return ok;
 
     mapi_mem_ctx = talloc_init(&quot;fetchmail&quot;);
 
@@ -381,10 +349,6 @@
 	return ok;
     }
 
-    /*
-     * Open Inbox 
-     */
-
     /*-----------------------------------------------------------------------------
      *  Open folder
      *  TODO: open folder specified by --folder option
@@ -394,29 +358,49 @@
      *  open inbox by default
      *-----------------------------------------------------------------------------*/
     retval = GetDefaultFolder(&amp;mapi_obj_store, &amp;id_folder, olFolderInbox);
-    MAPI_RETVAL_IF(retval, retval, mapi_mem_ctx);
+    if (retval != MAPI_E_SUCCESS) {
+	report(stderr, GT_(&quot;MAPI: OpenMsgStore failed\n&quot;));
+	ok = GetLastError();
+	mapi_clean();
+	return ok;
+    }
 
     mapi_object_init(&amp;mapi_obj_inbox);
     retval = OpenFolder(&amp;mapi_obj_store, id_folder, &amp;mapi_obj_inbox);
-    MAPI_RETVAL_IF(retval, retval, mapi_mem_ctx);
+    if (retval != MAPI_E_SUCCESS) {
+	report(stderr, GT_(&quot;MAPI: OpenMsgStore failed\n&quot;));
+	ok = GetLastError();
+	mapi_clean();
+	return ok;
+    }
 
     mapi_object_init(&amp;mapi_obj_table);
     retval = GetContentsTable(&amp;mapi_obj_inbox, &amp;mapi_obj_table, 0, &amp;count);
-    MAPI_RETVAL_IF(retval, retval, mapi_mem_ctx);
+    if (retval != MAPI_E_SUCCESS) {
+	report(stderr, GT_(&quot;MAPI: OpenMsgStore failed\n&quot;));
+	ok = GetLastError();
+	mapi_clean();
+	return ok;
+    }
 
     SPropTagArray = set_SPropTagArray(mapi_mem_ctx, 0x2, PR_FID, PR_MID);
     retval = SetColumns(&amp;mapi_obj_table, SPropTagArray);
     MAPIFreeBuffer(SPropTagArray);
-    MAPI_RETVAL_IF(retval, retval, mapi_mem_ctx);
+    if (retval != MAPI_E_SUCCESS) {
+	report(stderr, GT_(&quot;MAPI: OpenMsgStore failed\n&quot;));
+	ok = GetLastError();
+	mapi_clean();
+	return ok;
+    }
 
     retval = QueryRows(&amp;mapi_obj_table, count, TBL_ADVANCE, &amp;mapi_rowset);
-
     if (retval != MAPI_E_SUCCESS) {
 	ok = GetLastError();
 	mapi_clean();
 	return ok;
     }
 
+    mapi_id_array_init(&amp;mapi_deleted_ids);
     mapi_initialized = TRUE;
     return ok;
 }
@@ -511,89 +495,8 @@
     }
 }
 
-
 /*
  * ===  FUNCTION  ======================================================================
- *         Name:  expunge_seen
- *  Description:  set the MSGFLAG_READ property of the emails in the mapi_seen_list
- * =====================================================================================
- */
-static int
-expunge_seen()
-{
-    enum MAPISTATUS retval;
-    struct SPropTagArray *SPropTagArray = NULL;
-    struct SPropValue *lpProps;
-    struct SRow     aRow;
-    int             ok = PS_SUCCESS;
-    const char     *msgid;
-    mapi_object_t   obj_message;
-    mapi_id_t      *fid;
-    mapi_id_t      *mid;
-    int             props_count;
-    int             i;
-    int             seen_idx;
-
-
-    ok = mapi_init(NULL);
-    if (ok)
-	return translate_mapi_error(ok);
-
-    if (mapi_rowset.cRows == 0)
-	return PS_NOMAIL;
-
-    for (i = 1; i &lt; mapi_seen_list[0] &amp;&amp; mapi_seen_list[i] &lt;= mapi_rowset.cRows; i++) {
-	seen_idx = mapi_seen_list[i];
-	fid = (mapi_id_t *)
-	    find_SPropValue_data(&amp;(mapi_rowset.aRow[seen_idx - 1]), PR_FID);
-	mid = (mapi_id_t *)
-	    find_SPropValue_data(&amp;(mapi_rowset.aRow[seen_idx - 1]), PR_MID);
-	mapi_object_init(&amp;obj_message);
-
-	retval = OpenMessage(&amp;mapi_obj_store, *fid, *mid, &amp;obj_message, 0x0);
-
-	if (retval == MAPI_E_SUCCESS) {
-	    SPropTagArray = set_SPropTagArray(mapi_mem_ctx, 0x2, PR_INTERNET_MESSAGE_ID, PR_MESSAGE_FLAGS);
-	    retval = GetProps(&amp;obj_message, SPropTagArray, &amp;lpProps, &amp;props_count);
-	    MAPIFreeBuffer(SPropTagArray);
-	    if (retval != MAPI_E_SUCCESS) {
-		ok = translate_mapi_error(GetLastError());
-		talloc_free(lpProps);
-		mapi_object_release(&amp;obj_message);
-		mapi_clean();
-		return ok;
-	    }
-
-	    /*
-	     * Build a SRow structure 
-	     */
-	    aRow.ulAdrEntryPad = 0;
-	    aRow.cValues = props_count;
-	    aRow.lpProps = lpProps;
-
-	    msgid = (const char *) find_SPropValue_data(&amp;aRow, PR_INTERNET_MESSAGE_ID);
-	    long            message_flags = *(const long *) find_SPropValue_data(&amp;aRow,
-										 PR_MESSAGE_FLAGS);
-	    if (msgid &amp;&amp; !(message_flags &amp; MSGFLAG_READ)) {
-		// mark this email as seen
-		retval = SetMessageReadFlag(&amp;mapi_obj_inbox, &amp;obj_message, MSGFLAG_READ);
-		if (retval != MAPI_E_SUCCESS) {
-		    talloc_free(lpProps);
-		    mapi_object_release(&amp;obj_message);
-		    return translate_mapi_error(GetLastError());
-		}
-	    }
-	    talloc_free(lpProps);
-	}
-	mapi_object_release(&amp;obj_message);
-    }
-
-    return PS_SUCCESS;
-}
-
-
-/*
- * ===  FUNCTION  ======================================================================
  *         Name:  expunge_deleted
  *  Description:  move the emails in the mapi_deleted_list into &quot;deleted items&quot; folder
  * =====================================================================================
@@ -603,61 +506,47 @@
 {
     enum MAPISTATUS retval;
     mapi_id_t       id_folder;
-    struct SPropTagArray *SPropTagArray = NULL;
-    struct SPropValue *lpProps;
-    struct SRow     aRow;
-    int             ok = PS_SUCCESS;
-    const char     *msgid;
-    mapi_object_t   obj_message;
-    mapi_object_t   obj_deleted;
-    mapi_id_array_t msg_id_array;
-    mapi_id_t      *fid;
-    mapi_id_t      *mid;
-    int             props_count;
-    int             i;
-    int             deleted_idx;
+    mapi_object_t   obj_deleted;	/* &quot;deleted items&quot; folder, for soft delete */
+    mapi_id_t      *hard_deleted_ids;	/* ids of to-be-deleted messages, for hard deleted */
+    int             hard_delete = TRUE;
 
-    ok = mapi_init(NULL);
-    if (ok)
-	return translate_mapi_error(ok);
-
-    if (mapi_rowset.cRows == 0)
-	return PS_NOMAIL;
-
-    mapi_id_array_init(&amp;msg_id_array);
-    for (i = 1; i &lt;= mapi_deleted_list[0]
-	 &amp;&amp; mapi_deleted_list[i] &lt;= mapi_rowset.cRows; i++) {
-	deleted_idx = mapi_deleted_list[i];
-	fid = (mapi_id_t *)
-	    find_SPropValue_data(&amp;(mapi_rowset.aRow[deleted_idx - 1]), PR_FID);
-	mid = (mapi_id_t *)
-	    find_SPropValue_data(&amp;(mapi_rowset.aRow[deleted_idx - 1]), PR_MID);
-	mapi_object_init(&amp;obj_message);
-
-	retval = OpenMessage(&amp;mapi_obj_store, *fid, *mid, &amp;obj_message, 0x0);
-	if (retval == MAPI_E_SUCCESS) {
-	    // move this email into &quot;deleted items&quot; folder
-	    mapi_id_array_add_obj(&amp;msg_id_array, &amp;obj_message);
-	    if (outlevel == O_DEBUG)
-		report(stdout, &quot;message in mapi_rowset.aRow[%d] will be moved to deleted items folder\n&quot;, deleted_idx - 1);
+    /*-----------------------------------------------------------------------------
+     *  perform hard delete
+     *-----------------------------------------------------------------------------*/
+    if (hard_delete) {
+	mapi_id_array_get(mapi_mem_ctx, &amp;mapi_deleted_ids, &amp;hard_deleted_ids);
+	retval = DeleteMessage(&amp;mapi_obj_inbox, hard_deleted_ids, mapi_deleted_ids.count);
+	if (retval != MAPI_E_SUCCESS) {
+	    report(stderr, &quot;MAPI: DeleteMessages failed &quot;);
+	    talloc_free(hard_deleted_ids);
+	    return translate_mapi_error(GetLastError());
 	}
-	mapi_object_release(&amp;obj_message);
+	talloc_free(hard_deleted_ids);
+	return (PS_SUCCESS);
     }
 
+    /*-----------------------------------------------------------------------------
+     *  perform soft delete, move to-be-deleted messages to &quot;deleted items&quot; folder
+     *-----------------------------------------------------------------------------*/
+
+    /*-----------------------------------------------------------------------------
+     *  open &quot;deleted items&quot; folder
+     *-----------------------------------------------------------------------------*/
     mapi_object_init(&amp;obj_deleted);
     retval = GetDefaultFolder(&amp;mapi_obj_store, &amp;id_folder, olFolderDeletedItems);
     retval = OpenFolder(&amp;mapi_obj_store, id_folder, &amp;obj_deleted);
     if (retval != MAPI_E_SUCCESS) {
-	mapi_id_array_release(&amp;msg_id_array);
+	report(stderr, &quot;MAPI: OpenFolder failed\n&quot;);
 	return translate_mapi_error(GetLastError());
     }
 
-    retval = MoveCopyMessages(&amp;mapi_obj_inbox, &amp;obj_deleted, &amp;msg_id_array, 0);
-    if (retval != MAPI_E_SUCCESS &amp;&amp; outlevel == O_DEBUG)
-	mapi_errstr(&quot;MAPI&gt; MoveCopyMessages&quot;, GetLastError());
-    mapi_id_array_release(&amp;msg_id_array);
+    retval = MoveCopyMessages(&amp;mapi_obj_inbox, &amp;obj_deleted, &amp;mapi_deleted_ids, 0);
+    if (retval != MAPI_E_SUCCESS) {
+	report(stderr, &quot;MAPI: MoveCopyMessages failed\n&quot;);
+	return translate_mapi_error(GetLastError());
+    }
 
-    return translate_mapi_error(GetLastError());
+    return (PS_SUCCESS);
 }
 
 
@@ -672,13 +561,7 @@
 {
     if (outlevel &gt;= O_MONITOR)
 	report(stdout, &quot;MAPI&gt; mapi_ok()\n&quot;);
-	/*-----------------------------------------------------------------------------
-	 *  initialize the lists
-	 *-----------------------------------------------------------------------------*/
-    memset(mapi_deleted_list, 0, sizeof(mapi_deleted_list));
-    memset(mapi_seen_list, 0, sizeof(mapi_seen_list));
 
-
     return PS_SUCCESS;
 }
 
@@ -784,7 +667,7 @@
     } else
 	workstation = ctl-&gt;mapi_workstation;
 
-     /*-----------------------------------------------------------------------------
+    /*-----------------------------------------------------------------------------
      *  mapi_domain is a required option! how to check if it is specified?
      *  if not specified, default values of workstation, ldif and mapi_lcid (set in 
      *  fetchmail.c) are used
@@ -885,9 +768,12 @@
 }
 
 
-/*-----------------------------------------------------------------------------
- *  get range of messages to be fetched
- *-----------------------------------------------------------------------------*/
+/*
+ * ===  FUNCTION  ======================================================================
+ *         Name:  mapi_getrange
+ *  Description:  get range of messages to be fetched
+ * =====================================================================================
+ */
 static int
 mapi_getrange(int sock, struct query *ctl, const char *folder, int *countp, int *newp, int *bytes)
 {
@@ -910,17 +796,18 @@
     *newp = 0;
     *bytes = 0;
 
+
+    /*-----------------------------------------------------------------------------
+     * initialize mapi here
+     *-----------------------------------------------------------------------------*/
     ok = mapi_init(NULL);
     if (ok) {
-	report(stderr, GT_(&quot;MAPI: MAPI initilize error in mapi_getrange\n&quot;));
-	return translate_mapi_error(ok);
+	report(stderr, GT_(&quot;MAPI: MAPI is not initialized\n&quot;));
+	return (PS_UNDEFINED);
     }
 
     *countp = mapi_rowset.cRows;
 
-    if (mapi_rowset.cRows == 0)
-	return PS_NOMAIL;
-
     for (i = 0; i &lt; mapi_rowset.cRows; i++) {
 	fid = (mapi_id_t *) find_SPropValue_data(&amp;(mapi_rowset.aRow[i]), PR_FID);
 	mid = (mapi_id_t *) find_SPropValue_data(&amp;(mapi_rowset.aRow[i]), PR_MID);
@@ -940,9 +827,9 @@
 		return ok;
 	    }
 
-	    /*
-	     * Build a SRow structure 
-	     */
+	    /*-----------------------------------------------------------------------------
+	     *  build a SRow structure
+	     *-----------------------------------------------------------------------------*/
 	    aRow.ulAdrEntryPad = 0;
 	    aRow.cValues = props_count;
 	    aRow.lpProps = lpProps;
@@ -981,6 +868,8 @@
     int             props_count;
     mapi_object_t   obj_message;
     const char     *msgid;
+    mapi_id_t      *fid;
+    mapi_id_t      *mid;
     int             i;
 
     if (first != -1) {
@@ -989,18 +878,11 @@
     } else
 	first = 1;
 
-    ok = mapi_init(NULL);
-    if (ok) {
-	report(stderr, GT_(&quot;MAPI: MAPI initilize error in mapi_getpartialsizes/mapi_getsizes\n&quot;));
-	return translate_mapi_error(ok);
+    if (!mapi_initialized) {
+	report(stderr, GT_(&quot;MAPI: MAPI is not initialized\n&quot;));
+	return (PS_UNDEFINED);
     }
 
-    if (mapi_rowset.cRows == 0)
-	return PS_NOMAIL;
-
-    mapi_id_t      *fid,
-                   *mid;
-
     for (i = first; i &lt;= mapi_rowset.cRows &amp;&amp; i &lt;= last; i++) {
 	fid = (mapi_id_t *) find_SPropValue_data(&amp;(mapi_rowset.aRow[i - 1]), PR_FID);
 	mid = (mapi_id_t *) find_SPropValue_data(&amp;(mapi_rowset.aRow[i - 1]), PR_MID);
@@ -1083,10 +965,9 @@
     if (outlevel &gt;= O_MONITOR)
 	report(stdout, &quot;MAPI&gt; mapi_is_old(number %d)\n&quot;, number);
 
-    ok = mapi_init(NULL);
-    if (ok) {
-	report(stderr, GT_(&quot;MAPI: MAPI initilize error in mapi_is_old\n&quot;));
-	return FALSE;
+    if (!mapi_initialized) {
+	report(stderr, GT_(&quot;MAPI: MAPI is not initialized\n&quot;));
+	return (PS_UNDEFINED);
     }
 
     if (mapi_rowset.cRows &lt; number)
@@ -1157,16 +1038,18 @@
     const char     *subject = NULL;
     const uint8_t  *has_attach = NULL;
     char           *temp_line;
+    uint8_t         format;
     int             props_count;
 
+    (void) ctl;
+    *lenp = 0;
 
     if (outlevel &gt;= O_MONITOR)
 	report(stdout, &quot;MAPI&gt; mapi_fetch_headers(number %d)\n&quot;, number);
-    (void) ctl;
-    ok = mapi_init(NULL);
-    if (ok) {
-	report(stderr, GT_(&quot;MAPI: MAPI initilize error in mapi_fetch_headers\n&quot;));
-	return translate_mapi_error(ok);
+
+    if (!mapi_initialized) {
+	report(stderr, GT_(&quot;MAPI: MAPI is not initialized\n&quot;));
+	return (PS_UNDEFINED);
     }
 
     if (mapi_rowset.cRows &lt; number)
@@ -1179,13 +1062,13 @@
     retval = OpenMessage(&amp;mapi_obj_store, *fid, *mid, &amp;obj_message, 0x0);
     if (retval == MAPI_E_SUCCESS) {
 	SPropTagArray = set_SPropTagArray(mapi_mem_ctx,
-					  0x09,
+					  0x0a,
 					  PR_MESSAGE_FLAGS,
 					  PR_INTERNET_MESSAGE_ID,
 					  PR_CONVERSATION_TOPIC,
 					  PR_MESSAGE_DELIVERY_TIME,
 					  PR_SENT_REPRESENTING_NAME,
-					  PR_DISPLAY_TO, PR_DISPLAY_CC, PR_DISPLAY_BCC, PR_HASATTACH);
+					  PR_DISPLAY_TO, PR_DISPLAY_CC, PR_DISPLAY_BCC, PR_HASATTACH, PR_MSG_EDITOR_FORMAT);
 	retval = GetProps(&amp;obj_message, SPropTagArray, &amp;lpProps, &amp;props_count);
 	MAPIFreeBuffer(SPropTagArray);
 	if (retval != MAPI_E_SUCCESS) {
@@ -1229,60 +1112,114 @@
 	mapi_buffer.length = 0;
 	mapi_buffer_count = 0;
 
-	temp_line = talloc_asprintf(mapi_mem_ctx, &quot;From \&quot;%s\&quot; %s\n&quot;, from, date);
-	data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-	talloc_free(temp_line);
-
 	temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Date: %s\n&quot;, date);
 	data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	*lenp += strlen(temp_line);
 	talloc_free(temp_line);
 
 	temp_line = talloc_asprintf(mapi_mem_ctx, &quot;From: %s\n&quot;, from);
 	data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	*lenp += strlen(temp_line);
 	talloc_free(temp_line);
 
 	if (to) {
 	    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;To: %s\n&quot;, to);
 	    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	    *lenp += strlen(temp_line);
 	    talloc_free(temp_line);
 	}
 
 	if (cc) {
 	    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Cc: %s\n&quot;, cc);
 	    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	    *lenp += strlen(temp_line);
 	    talloc_free(temp_line);
 	}
 
 	if (bcc) {
 	    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Bcc: %s\n&quot;, bcc);
 	    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	    *lenp += strlen(temp_line);
 	    talloc_free(temp_line);
 	}
 
 	if (subject) {
 	    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Subject: %s\n&quot;, subject);
 	    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	    *lenp += strlen(temp_line);
 	    talloc_free(temp_line);
 	}
 
 	temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Message-ID: %s\n&quot;, msgid);
 	data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	*lenp += strlen(temp_line);
 	talloc_free(temp_line);
 
+	temp_line = talloc_asprintf(mapi_mem_ctx, &quot;MIME-Version: 1.0\n&quot;);
+	data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	*lenp += strlen(temp_line);
+	talloc_free(temp_line);
+
 	if (has_attach &amp;&amp; *has_attach) {
+	    /*-----------------------------------------------------------------------------
+	     * simple structure 
+	     *-----------------------------------------------------------------------------*/
 	    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: multipart/mixed; boundary=\&quot;%s\&quot;\n&quot;, MAPI_BOUNDARY);
 	    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	    *lenp += strlen(temp_line);
 	    talloc_free(temp_line);
+	} else {
+	    /*-----------------------------------------------------------------------------
+	     * complex structure 
+	     *-----------------------------------------------------------------------------*/
+	    retval = GetBestBody(&amp;obj_message, &amp;format);
+	    switch (format) {
+	    case olEditorText:
+		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: text/plain; charset=us-ascii\n&quot;);
+		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		*lenp += strlen(temp_line);
+		talloc_free(temp_line);
+
+		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: quoted-printable\n&quot;);
+		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		*lenp += strlen(temp_line);
+		talloc_free(temp_line);
+		break;
+	    case olEditorHTML:
+		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: text/html\n&quot;);
+		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		*lenp += strlen(temp_line);
+		talloc_free(temp_line);
+
+		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: quoted-printable\n&quot;);
+		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		*lenp += strlen(temp_line);
+		talloc_free(temp_line);
+		break;
+	    case olEditorRTF:
+		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: text/rtf\n&quot;);
+		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		*lenp += strlen(temp_line);
+		talloc_free(temp_line);
+
+		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: quoted-printable\n&quot;);
+		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		*lenp += strlen(temp_line);
+		talloc_free(temp_line);
+		break;
+	    }
 	}
 
 	temp_line = talloc_asprintf(mapi_mem_ctx, &quot;\n&quot;);
 	data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	*lenp += strlen(temp_line);
 	talloc_free(temp_line);
     } else {
 	talloc_free(lpProps);
 	mapi_object_release(&amp;obj_message);
 	return (PS_UNDEFINED);
     }
+    talloc_free(lpProps);
     mapi_object_release(&amp;obj_message);
 
     return ok;
@@ -1325,24 +1262,20 @@
     int             attach_count;
     uint8_t         format;
 
+    (void) ctl;
+    *lenp = 0;
 
     if (outlevel &gt;= O_MONITOR)
 	report(stdout, &quot;MAPI&gt; mapi_fetch_body(number %d)\n&quot;, number);
 
-    (void) ctl;
-    ok = mapi_init(NULL);
-    if (ok) {
-	report(stderr, GT_(&quot;MAPI: MAPI initilize error in mapi_fetch_body\n&quot;));
-	return translate_mapi_error(ok);
+    if (!mapi_initialized) {
+	report(stderr, GT_(&quot;MAPI: MAPI is not initialized\n&quot;));
+	return (PS_UNDEFINED);
     }
+
     if (mapi_rowset.cRows &lt; number)
 	return (PS_UNDEFINED);
 
-    talloc_free(mapi_buffer.data);
-    mapi_buffer.data = NULL;
-    mapi_buffer.length = 0;
-    mapi_buffer_count = 0;
-
     fid = (mapi_id_t *) find_SPropValue_data(&amp;(mapi_rowset.aRow[number - 1]), PR_FID);
     mid = (mapi_id_t *) find_SPropValue_data(&amp;(mapi_rowset.aRow[number - 1]), PR_MID);
     mapi_object_init(&amp;obj_message);
@@ -1362,9 +1295,10 @@
 	    return translate_mapi_error(GetLastError());
 	}
     }
-    /*
-     * Build a SRow structure 
-     */
+
+    /*-----------------------------------------------------------------------------
+     *  build a SRow structure
+     *-----------------------------------------------------------------------------*/
     aRow.ulAdrEntryPad = 0;
     aRow.cValues = props_count;
     aRow.lpProps = lpProps;
@@ -1373,60 +1307,75 @@
     if (msgid) {
 	has_attach = (const uint8_t *) find_SPropValue_data(&amp;aRow, PR_HASATTACH);
 	retval = octool_get_body(mapi_mem_ctx, &amp;obj_message, &amp;aRow, &amp;body);
-	/*
-	 * body 
-	 */
+
+	/*-----------------------------------------------------------------------------
+	 *  body
+	 *-----------------------------------------------------------------------------*/
 	if (body.length) {
 	    if (has_attach &amp;&amp; *has_attach) {
 		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;--%s\n&quot;, MAPI_BOUNDARY);
 		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		*lenp += strlen(temp_line);
 		talloc_free(temp_line);
-	    }
-	    retval = GetBestBody(&amp;obj_message, &amp;format);
-	    switch (format) {
-	    case olEditorText:
-		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: text/plain; charset=us-ascii\n&quot;);
-		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-		talloc_free(temp_line);
 
-		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: quoted-printable\n&quot;);
-		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-		talloc_free(temp_line);
-		/*
-		 * Just display UTF8 content inline 
-		 */
-		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Disposition: inline\n&quot;);
-		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-		talloc_free(temp_line);
-		break;
-	    case olEditorHTML:
-		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: text/html\n&quot;);
-		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-		talloc_free(temp_line);
 
-		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: quoted-printable\n&quot;);
-		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-		talloc_free(temp_line);
-		break;
-	    case olEditorRTF:
-		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: text/rtf\n&quot;);
-		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-		talloc_free(temp_line);
+		/*-----------------------------------------------------------------------------
+		 *  complex structure
+		 *-----------------------------------------------------------------------------*/
+		retval = GetBestBody(&amp;obj_message, &amp;format);
+		switch (format) {
+		case olEditorText:
+		    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: text/plain; charset=us-ascii\n&quot;);
+		    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		    *lenp += strlen(temp_line);
+		    talloc_free(temp_line);
 
-		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: quoted-printable\n&quot;);
-		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-		talloc_free(temp_line);
+		    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: quoted-printable\n&quot;);
+		    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		    *lenp += strlen(temp_line);
+		    talloc_free(temp_line);
+		    /*
+		     * Just display UTF8 content inline 
+		     */
+		    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Disposition: inline\n&quot;);
+		    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		    *lenp += strlen(temp_line);
+		    talloc_free(temp_line);
+		    break;
+		case olEditorHTML:
+		    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: text/html\n&quot;);
+		    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		    *lenp += strlen(temp_line);
+		    talloc_free(temp_line);
 
-		temp_line = talloc_asprintf(mapi_mem_ctx, &quot;--%s\n&quot;, MAPI_BOUNDARY);
-		data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-		talloc_free(temp_line);
-		break;
+		    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: quoted-printable\n&quot;);
+		    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		    *lenp += strlen(temp_line);
+		    talloc_free(temp_line);
+		    break;
+		case olEditorRTF:
+		    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: text/rtf\n&quot;);
+		    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		    *lenp += strlen(temp_line);
+		    talloc_free(temp_line);
+
+		    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: quoted-printable\n&quot;);
+		    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		    *lenp += strlen(temp_line);
+		    talloc_free(temp_line);
+
+		    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;--%s\n&quot;, MAPI_BOUNDARY);
+		    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+		    *lenp += strlen(temp_line);
+		    talloc_free(temp_line);
+		    break;
+		}
 	    }
 
 	    /*-----------------------------------------------------------------------------
 	     *  encode body.data into quoted printable and append to mapi_buffer
 	     *-----------------------------------------------------------------------------*/
-	    quoted_printable_encode(&amp;body);
+	    quoted_printable_encode(&amp;body, lenp);
 	    talloc_free(body.data);
 
 	    /*-----------------------------------------------------------------------------
@@ -1468,23 +1417,28 @@
 				if (attachment_data) {
 				    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;\n\n--%s\n&quot;, MAPI_BOUNDARY);
 				    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+				    *lenp += strlen(temp_line);
 				    talloc_free(temp_line);
 
 				    temp_line =
 					talloc_asprintf(mapi_mem_ctx, &quot;Content-Disposition: attachment; filename=\&quot;%s\&quot;\n&quot;,
 							attach_filename);
 				    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+				    *lenp += strlen(temp_line);
 				    talloc_free(temp_line);
 
 				    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Type: \&quot;%s\&quot;\n&quot;, magic);
 				    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+				    *lenp += strlen(temp_line);
 				    talloc_free(temp_line);
 
 				    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;Content-Transfer-Encoding: base64\n\n&quot;);
 				    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+				    *lenp += strlen(temp_line);
 				    talloc_free(temp_line);
 
 				    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, attachment_data, strlen(attachment_data));
+				    *lenp += strlen(attachment_data);
 				    talloc_free(attachment_data);
 				}
 			    }
@@ -1494,20 +1448,22 @@
 		    if (has_attach &amp;&amp; *has_attach) {
 			temp_line = talloc_asprintf(mapi_mem_ctx, &quot;\n--%s--\n&quot;, MAPI_BOUNDARY);
 			data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+			*lenp += strlen(temp_line);
 			talloc_free(temp_line);
 		    }
-		}
-
-	    }
-
-
-	    /*-----------------------------------------------------------------------------
-	     *  send the message delimiter
-	     *-----------------------------------------------------------------------------*/
-	    temp_line = talloc_asprintf(mapi_mem_ctx, &quot;.\n&quot;, MAPI_BOUNDARY);
-	    data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
-	    talloc_free(temp_line);
+		}		/* if GetAttachmentTable returns success */
+	    }			/* if (has_attach &amp;&amp; *has_attach) */
 	}
+	/*
+	 * if (body.length) 
+	 */
+ /*-----------------------------------------------------------------------------
+	 *  send the message delimiter
+	 *-----------------------------------------------------------------------------*/
+	temp_line = talloc_asprintf(mapi_mem_ctx, &quot;\n.\n\0&quot;, MAPI_BOUNDARY);
+	data_blob_append(mapi_mem_ctx, &amp;mapi_buffer, temp_line, strlen(temp_line));
+	talloc_free(temp_line);
+	printf(&quot;mapi_buffer: %s&quot;, mapi_buffer.data);
     } else {
 	talloc_free(lpProps);
 	mapi_object_release(&amp;obj_message);
@@ -1546,13 +1502,47 @@
 static int
 mapi_delete(int sock, struct query *ctl, int number)
 {
+    enum MAPISTATUS retval;
+    struct SPropTagArray *SPropTagArray = NULL;
+    struct SPropValue *lpProps;
+    struct SRow     aRow;
+    int             ok;
+    const char     *msgid;
+    mapi_object_t   obj_message;
+    mapi_id_t      *fid;
+    mapi_id_t      *mid;
+    int             props_count;
+
     if (outlevel &gt;= O_MONITOR)
 	report(stdout, &quot;MAPI&gt; mapi_delete(number %d)\n&quot;, number);
-    /*-----------------------------------------------------------------------------
-     * perform a soft delete here
-     * -----------------------------------------------------------------------------*/
-    if (insert(number, MAPI_DELETED_LIST) == FALSE)
-	return PS_UNDEFINED;
+
+    if (!mapi_initialized)
+	return (PS_UNDEFINED);
+
+    if (mapi_rowset.cRows == 0)
+	return PS_NOMAIL;
+
+
+    fid = (mapi_id_t *)
+	find_SPropValue_data(&amp;(mapi_rowset.aRow[number - 1]), PR_FID);
+    mid = (mapi_id_t *)
+	find_SPropValue_data(&amp;(mapi_rowset.aRow[number - 1]), PR_MID);
+    mapi_object_init(&amp;obj_message);
+
+    retval = OpenMessage(&amp;mapi_obj_store, *fid, *mid, &amp;obj_message, 0x0);
+    if (retval == MAPI_E_SUCCESS) {
+	    /*-----------------------------------------------------------------------------
+	     * add the message id to the list 
+	     *-----------------------------------------------------------------------------*/
+	mapi_id_array_add_obj(&amp;mapi_deleted_ids, &amp;obj_message);
+	if (outlevel == O_DEBUG)
+	    report(stdout, &quot;message in mapi_rowset.aRow[%d] will be deleted\n&quot;, number - 1);
+    } else {
+	mapi_object_release(&amp;obj_message);
+	return translate_mapi_error(GetLastError());
+    }
+    mapi_object_release(&amp;obj_message);
+
     return PS_SUCCESS;
 }
 
@@ -1560,20 +1550,89 @@
 /*
  * ===  FUNCTION  ======================================================================
  *         Name:  mapi_mark_seen
- *  Description:  make the given message as seen
+ *  Description:  make the given message as seen in both client and server sides
  * =====================================================================================
  */
 static int
 mapi_mark_seen(int sock, struct query *ctl, int number)
 {
+    enum MAPISTATUS retval;
+    int             ok;
+    int             flag = FALSE;
+    struct SPropTagArray *SPropTagArray = NULL;
+    struct SPropValue *lpProps;
+    struct SRow     aRow;
+    mapi_object_t   obj_message;
+    const char     *msgid = NULL;
+    const char     *profname = NULL;
+    mapi_id_t      *fid;
+    mapi_id_t      *mid;
+    int             props_count;
+    long            message_flags;
+
     if (outlevel &gt;= O_MONITOR)
 	report(stdout, &quot;MAPI&gt; mapi_mark_seen(number %d)\n&quot;, number);
-    /*-----------------------------------------------------------------------------
-     *  perform a soft mark-seen here
-     *-----------------------------------------------------------------------------*/
-    if (insert(number, MAPI_SEEN_LIST))
-	return PS_UNDEFINED;
-    return PS_SUCCESS;
+
+    if (!mapi_initialized) {
+	report(stderr, GT_(&quot;MAPI: MAPI is not initialized\n&quot;));
+	return (PS_UNDEFINED);
+    }
+
+    if (mapi_rowset.cRows &lt; number)
+	return FALSE;
+
+    fid = (mapi_id_t *) find_SPropValue_data(&amp;(mapi_rowset.aRow[number - 1]), PR_FID);
+    mid = (mapi_id_t *) find_SPropValue_data(&amp;(mapi_rowset.aRow[number - 1]), PR_MID);
+    mapi_object_init(&amp;obj_message);
+
+    retval = OpenMessage(&amp;mapi_obj_store, *fid, *mid, &amp;obj_message, 0x0);
+    if (retval == MAPI_E_SUCCESS) {
+	SPropTagArray = set_SPropTagArray(mapi_mem_ctx, 0x2, PR_INTERNET_MESSAGE_ID, PR_MESSAGE_FLAGS);
+	retval = GetProps(&amp;obj_message, SPropTagArray, &amp;lpProps, &amp;props_count);
+	MAPIFreeBuffer(SPropTagArray);
+	if (retval == MAPI_E_SUCCESS) {
+	    /*
+	     * Build a SRow structure 
+	     */
+	    aRow.ulAdrEntryPad = 0;
+	    aRow.cValues = props_count;
+	    aRow.lpProps = lpProps;
+
+	    msgid = (const char *) find_SPropValue_data(&amp;aRow, PR_INTERNET_MESSAGE_ID);
+	    message_flags = *(const long *) find_SPropValue_data(&amp;aRow, PR_MESSAGE_FLAGS);
+	    if (msgid) {
+
+		/*-----------------------------------------------------------------------------
+		 * mark seen in the client side
+		 *-----------------------------------------------------------------------------*/
+		if (!ctl-&gt;mapi_profname)
+		    profname = ctl-&gt;remotename;	/* use the remotename as the profile name */
+		else
+		    profname = ctl-&gt;mapi_profname;
+		mapi_profile_add_string_attr(profname, &quot;Message-ID&quot;, msgid);
+		if (retval == MAPI_E_SUCCESS) {
+		    if (outlevel == O_DEBUG)
+			report(stdout, &quot;MAPI&gt; marked message %d with Message-ID=%s seen\n&quot;, number, msgid);
+		    flag = TRUE;
+		}
+
+		/*-----------------------------------------------------------------------------
+		 *  mark seen in the server side
+		 *-----------------------------------------------------------------------------*/
+		if (!(message_flags &amp; MSGFLAG_READ)) {
+		    retval = SetMessageReadFlag(&amp;mapi_obj_inbox, &amp;obj_message, MSGFLAG_READ);
+		    if (retval != MAPI_E_SUCCESS) {
+			// TODO: how to handle this?
+		    }
+		}
+	    }
+	} else
+	    mapi_clean();
+	talloc_free(lpProps);
+    }
+    mapi_object_release(&amp;obj_message);
+
+    return flag;
 }
 
 
@@ -1581,7 +1640,7 @@
 /*
  * ===  FUNCTION  ======================================================================
  *         Name:  mapi_end_mailbox_poll
- *  Description:  perform hard mark-seen and delete here
+ *  Description:  perform hard delete here
  * =====================================================================================
  */
 static int
@@ -1589,25 +1648,12 @@
 {
     int             ok = PS_SUCCESS;
     (void) ctl;
+
     if (outlevel &gt;= O_MONITOR)
 	report(stdout, &quot;MAPI&gt; mapi_end_mailbox_poll()\n&quot;);
 
-
-    if (mapi_seen_list[0]) {
-	ok = expunge_seen();
-	if (ok == PS_SUCCESS)
-	    mapi_seen_list[0] = 0;
-	else
-	    return ok;
-    }
-
-    if (mapi_deleted_list[0]) {
-	ok = expunge_deleted();
-	if (ok == PS_SUCCESS)
-	    mapi_deleted_list[0] = 0;
-	else
-	    return ok;
-    }
+    ok = expunge_deleted();
+    mapi_id_array_release(&amp;mapi_deleted_ids);
     mapi_clean();
     mapi_initialized = FALSE;
     return ok;
@@ -1617,23 +1663,11 @@
 mapi_logout(int sock, struct query *ctl)
 {
     int             ok = PS_SUCCESS;
+    (void) ctl;
+
     if (outlevel &gt;= O_MONITOR)
 	report(stdout, &quot;MAPI&gt; mapi_logout()\n&quot;);
 
-    (void) ctl;
-    if (mapi_seen_list[0]) {
-	ok = expunge_seen();
-	if (ok == PS_SUCCESS)
-	    mapi_seen_list[0] = 0;
-    }
-
-    if (mapi_deleted_list[0]) {
-	ok = expunge_deleted();
-	if (ok == PS_SUCCESS)
-	    mapi_deleted_list[0] = 0;
-    }
-    mapi_clean();
-    mapi_initialized = FALSE;
     return ok;
 }
 
@@ -1659,16 +1693,20 @@
     TRUE,			/* yes, we can re-poll */
 };
 
+
+/*
+ * ===  FUNCTION  ======================================================================
+ *         Name:  doMAPI
+ *  Description:  retrieve messages using MAPI
+ * =====================================================================================
+ */
 int
 doMAPI(struct query *ctl)
-	/*
-	 * retrieve messages using MAPI 
-	 */
 {
     return (do_protocol(ctl, &amp;mapi));
 }
 #endif				/* case MAPI_ENABLE */
 
-    /*
-     * mapi.c ends here 
-     */
+/*
+ * mapi.c ends here 
+ */

Modified: branches/BRANCH_MAPI/transact.c
===================================================================
--- branches/BRANCH_MAPI/transact.c	2008-07-14 14:52:55 UTC (rev 5217)
+++ branches/BRANCH_MAPI/transact.c	2008-07-17 13:41:47 UTC (rev 5218)
@@ -450,63 +450,44 @@
 	linelen = 0;
 	line[0] = '\0';
 	do {
-	    if (ctl-&gt;server.protocol != P_MAPI)
-	    {
-	        do {
-		    char	*sp, *tp;
+	    do {
+		char	*sp, *tp;
 
-		    set_timeout(mytimeout);
+		set_timeout(mytimeout);
+		if (ctl-&gt;server.protocol != P_MAPI)
+		{
 		    if ((n = SockRead(sock, buf, sizeof(buf)-1)) == -1) {
 		        set_timeout(0);
 		        free(line);
 		        return(PS_SOCKET);
 		    }
-		    set_timeout(0);
-
-		    /*
-		     * Smash out any NULs, they could wreak havoc later on.
-		     * Some network stacks seem to generate these at random,
-		     * especially (according to reports) at the beginning of the
-		     * first read.  NULs are illegal in RFC822 format.
-		     */
-		    for (sp = tp = buf; sp &lt; buf + n; sp++)
-		        if (*sp)
-			    *tp++ = *sp;
-		    *tp = '\0';
-		    n = tp - buf;
-	        } while
-		      (n == 0);
-	    }
-	    else
-	    {
+		}
+		else
+		{
 #ifdef MAPI_ENABLE
-	        do {
-		    char	*sp, *tp;
-
-		    set_timeout(mytimeout);
 		    if ((n = MapiRead(sock, buf, sizeof(buf)-1)) == -1) {
 		        set_timeout(0);
 		        free(line);
 		        return(PS_SOCKET);
 		    }
-		    set_timeout(0);
-
-		    /*
-		     * Smash out any NULs, they could wreak havoc later on.
-		     * Some network stacks seem to generate these at random,
-		     * especially (according to reports) at the beginning of the
-		     * first read.  NULs are illegal in RFC822 format.
-		     */
-		    for (sp = tp = buf; sp &lt; buf + n; sp++)
-		        if (*sp)
-			    *tp++ = *sp;
-		    *tp = '\0';
-		    n = tp - buf;
-	        } while
-		      (n == 0);
 #endif
-	    }
+		}
+		set_timeout(0);
 
+		/*
+		 * Smash out any NULs, they could wreak havoc later on.
+		 * Some network stacks seem to generate these at random,
+		 * especially (according to reports) at the beginning of the
+		 * first read.  NULs are illegal in RFC822 format.
+		 */
+		for (sp = tp = buf; sp &lt; buf + n; sp++)
+		    if (*sp)
+			*tp++ = *sp;
+		*tp = '\0';
+		n = tp - buf;
+	    } while
+		  (n == 0);
+
 	    remaining -= n;
 	    linelen += n;
 	    msgblk.msglen += n;
@@ -1402,38 +1383,32 @@
      */
     while (protocol-&gt;delimited || len &gt; 0)
     {
+	set_timeout(mytimeout);
+	/* XXX FIXME: for undelimited protocols that ship the size, such
+	 * as IMAP, we might want to use the count of remaining characters
+	 * instead of the buffer size -- not for fetchmail 6.3.X though */
 	if(ctl-&gt;server.protocol != P_MAPI)
 	{
-	    set_timeout(mytimeout);
-	    /* XXX FIXME: for undelimited protocols that ship the size, such
-	     * as IMAP, we might want to use the count of remaining characters
-	     * instead of the buffer size -- not for fetchmail 6.3.X though */
 	    if ((linelen = SockRead(sock, inbufp, sizeof(buf)-4-(inbufp-buf)))==-1)
 	    {
 	        set_timeout(0);
 	        release_sink(ctl);
 	        return(PS_SOCKET);
 	    }
-	    set_timeout(0);
 	}
 	else
 	{
 #ifdef MAPI_ENABLE
-	    set_timeout(mytimeout);
-	    /* XXX FIXME: for undelimited protocols that ship the size, such
-	     * as IMAP, we might want to use the count of remaining characters
-	     * instead of the buffer size -- not for fetchmail 6.3.X though */
 	    if ((linelen = MapiRead(sock, inbufp, sizeof(buf)-4-(inbufp-buf)))==-1)
 	    {
 	        set_timeout(0);
 	        release_sink(ctl);
 	        return(PS_SOCKET);
 	    }
-	    set_timeout(0);
 #endif
 	}
+	set_timeout(0);
 
-
 	/* write the message size dots */
 	if (linelen &gt; 0)
 	{


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000205.html">[fetchmail-svn] r5217 - branches/BRANCH_MAPI
</A></li>
	<LI>Next message: <A HREF="000207.html">[fetchmail-svn] r5219 - branches/BRANCH_MAPI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#206">[ date ]</a>
              <a href="thread.html#206">[ thread ]</a>
              <a href="subject.html#206">[ subject ]</a>
              <a href="author.html#206">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/fetchmail-svn">More information about the fetchmail-svn
mailing list</a><br>
</body></html>
